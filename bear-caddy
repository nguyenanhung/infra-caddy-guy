#!/bin/bash

# Set BASE_DIR reliably based on main.sh location
if command -v realpath >/dev/null 2>&1; then
  BASE_DIR="$(dirname "$(realpath "$0")")"
else
  # Fallback for systems without realpath
  BASE_DIR="$(cd "$(dirname "$0")" && pwd)"
fi

# Export BASE_DIR to be available in sourced files
export BASE_DIR

source "$BASE_DIR/commons/config.sh"
source "$BASE_DIR/commons/utils.sh"
source "$BASE_DIR/services/caddy.sh"
source "$BASE_DIR/commons/menu.sh"
check_bash_version
check_require_packages "curl"
check_require_packages "fzf"
check_require_packages "jq"

# Parse command
case "$1" in
"")
  bear_welcome
  ;;
"init")
  setup_caddy
  ;;
"reload-caddy")
  restart_caddy
  ;;
"enable-"*)
  service_name="${1#enable-}"
  source "$BASE_DIR/services/common_services.sh"
  enable_service "$service_name"
  ;;
"stop-"*)
  service_name="${1#stop-}"
  source "$BASE_DIR/services/common_services.sh"
  stop_service "$service_name"
  ;;
"start-"*)
  service_name="${1#start-}"
  source "$BASE_DIR/services/common_services.sh"
  start_service "$service_name"
  ;;
"restart-"*)
  service_name="${1#restart-}"
  source "$BASE_DIR/services/common_services.sh"
  restart_service "$service_name"
  ;;
"remove-"*)
  service_name="${1#remove-}"
  source "$BASE_DIR/services/common_services.sh"
  remove_service "$service_name"
  ;;
"log-"*)
  service_name="${1#log-}"
  source "$BASE_DIR/services/common_services.sh"
  log_service "$service_name"
  ;;
"logs")
  shift                            # Shift to remove the first argument
  check_docker_container_logs "$@" # Call delete_site with the remaining arguments
  ;;
"list")
  site_list=$(list_sites)
  echo "$site_list"
  ;;
"install")
  options="Add new Reverse Proxy\nAdd new Load Balancer Cluster\nAdd new Laravel App\nBuild & Add new Laravel Application"
  choice=$(echo -e "$options" | fzf --prompt="Select an option: ")
  case "$choice" in
  "Add new Reverse Proxy") "$0" add-reverse-proxy ;;
  "Add new Load Balancer Cluster") "$0" add-load-balancer ;;
  "Add new Laravel App") "$0" add-laravel ;;
  "Build & Add new Laravel Application") "$0" laravel-up ;;
  esac
  ;;
"delete")
  shift            # Shift to remove the first argument
  delete_site "$@" # Call delete_site with the remaining arguments
  ;;
"stop")
  shift          # Shift to remove the first argument
  stop_site "$@" # Call delete_site with the remaining arguments
  ;;
"start")
  shift           # Shift to remove the first argument
  start_site "$@" # Call delete_site with the remaining arguments
  ;;
"restart")
  shift             # Shift to remove the first argument
  restart_site "$@" # Call delete_site with the remaining arguments
  ;;
"basic-auth")
  shift               # Shift to remove the first argument
  add_basic_auth "$@" # Call delete_site with the remaining arguments
  ;;
"delete-basic-auth")
  shift                  # Shift to remove the first argument
  delete_basic_auth "$@" # Call delete_site with the remaining arguments
  ;;
"add-reverse-proxy")
  source "$BASE_DIR/services/reverse-proxy.sh"
  shift                  # Shift to remove the first argument
  add_reverse_proxy "$@" # Call delete_site with the remaining arguments
  ;;
"delete-reverse-proxy")
  source "$BASE_DIR/services/reverse-proxy.sh"
  shift                     # Shift to remove the first argument
  delete_reverse_proxy "$@" # Call delete_site with the remaining arguments
  ;;
"add-load-balancer")
  source "$BASE_DIR/services/load-balancer.sh"
  shift                  # Shift to remove the first argument
  add_load_balancer "$@" # Call delete_site with the remaining arguments
  ;;
"delete-load-balancer")
  source "$BASE_DIR/services/load-balancer.sh"
  shift                     # Shift to remove the first argument
  delete_load_balancer "$@" # Call delete_site with the remaining arguments
  ;;
"delete-load-balancer-backend")
  source "$BASE_DIR/services/load-balancer.sh"
  shift                             # Shift to remove the first argument
  delete_load_balancer_backend "$@" # Call delete_site with the remaining arguments
  ;;
"laravel-up")
  source "$BASE_DIR/services/laravel-up.sh"
  shift           # Shift to remove the first argument
  laravel_up "$@" # Call delete_site with the remaining arguments
  ;;
"laravel-down")
  source "$BASE_DIR/services/laravel-up.sh"
  shift             # Shift to remove the first argument
  laravel_down "$@" # Call delete_site with the remaining arguments
  ;;
"laravel-restore")
  source "$BASE_DIR/services/laravel-up.sh"
  shift                # Shift to remove the first argument
  laravel_restore "$@" # Call delete_site with the remaining arguments
  ;;
"laravel-remove")
  source "$BASE_DIR/services/laravel-up.sh"
  shift               # Shift to remove the first argument
  laravel_remove "$@" # Call delete_site with the remaining arguments
  ;;
"add-laravel")
  source "$BASE_DIR/services/laravel.sh"
  shift            # Shift to remove the first argument
  add_laravel "$@" # Call delete_site with the remaining arguments
  ;;
"delete-laravel")
  source "$BASE_DIR/services/laravel.sh"
  shift               # Shift to remove the first argument
  delete_laravel "$@" # Call delete_site with the remaining arguments
  ;;
"add-static-site")
  source "$BASE_DIR/services/static-site.sh"
  shift                # Shift to remove the first argument
  add_static_site "$@" # Call delete_site with the remaining arguments
  ;;
"delete-static-site")
  source "$BASE_DIR/services/static-site.sh"
  shift                   # Shift to remove the first argument
  delete_static_site "$@" # Call delete_site with the remaining arguments
  ;;
"add-node-app")
  source "$BASE_DIR/services/node-app.sh"
  shift             # Shift to remove the first argument
  add_node_app "$@" # Call delete_site with the remaining arguments
  ;;
"delete-node-app")
  source "$BASE_DIR/services/node-app.sh"
  shift                # Shift to remove the first argument
  delete_node_app "$@" # Call delete_site with the remaining arguments
  ;;
"node-up")
  source "$BASE_DIR/services/node-up.sh"
  shift           # Shift to remove the first argument
  node_up "$@" # Call delete_site with the remaining arguments
  ;;
"node-down")
  source "$BASE_DIR/services/node-up.sh"
  shift             # Shift to remove the first argument
  node_down "$@" # Call delete_site with the remaining arguments
  ;;
"node-restore")
  source "$BASE_DIR/services/node-up.sh"
  shift                # Shift to remove the first argument
  node_restore "$@" # Call delete_site with the remaining arguments
  ;;
"node-remove")
  source "$BASE_DIR/services/node-up.sh"
  shift               # Shift to remove the first argument
  node_remove "$@" # Call delete_site with the remaining arguments
  ;;
"join-caddy")
  shift                       # Shift to remove the first argument
  docker_network_connect "$@" # Call delete_site with the remaining arguments
  ;;
"disconnect-caddy")
  shift                          # Shift to remove the first argument
  docker_network_disconnect "$@" # Call delete_site with the remaining arguments
  ;;
*)
  message ERROR "Unknown command: $1"
  exit 1
  ;;
esac
